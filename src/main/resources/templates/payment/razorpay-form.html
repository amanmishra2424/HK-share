<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Razorpay Payment - PDF Printing System</title>
</head>
<body>
    <div th:fragment="content">
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>Payment Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Payment Summary</h6>
                                    <div class="payment-summary">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Wallet Amount:</span>
                                            <span class="fw-bold">₹<span th:text="${walletAmount}">100</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2 text-warning">
                                            <span>Service Fee (<span th:text="${serviceFeePercentage}">2</span>%):</span>
                                            <span>₹<span th:text="${serviceFeeAmount}">2.00</span></span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span class="fw-bold">Total Payable:</span>
                                            <span class="fw-bold text-primary">₹<span th:text="${totalPayableAmount}">102.00</span></span>
                                        </div>
                                        <div class="alert alert-info">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                You pay ₹<span th:text="${totalPayableAmount}">102.00</span> (including service fee), 
                                                but ₹<span th:text="${walletAmount}">100</span> will be added to your wallet.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Customer Details</h6>
                                    <div class="customer-details">
                                        <p><strong>Name:</strong> <span th:text="${userName}">John Doe</span></p>
                                        <p><strong>Email:</strong> <span th:text="${userEmail}">john@example.com</span></p>
                                        <p><strong>Order ID:</strong> <span th:text="${orderId}">order_123</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="rzp-button" class="btn btn-primary btn-lg">
                                    <i class="fas fa-lock me-2"></i>Pay Securely with Razorpay
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Secured by Razorpay SSL Encryption
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <a href="/student/wallet" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Wallet
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://checkout.razorpay.com/v1/checkout.js" 
                onerror="console.error('Failed to load Razorpay script from CDN')"></script>
        <script th:inline="javascript">
            var options = {
                "key": /*[[${razorpayKeyId}]]*/ "rzp_test_key",
                "amount": /*[[${amountInPaise}]]*/ 10200,
                "currency": /*[[${currency}]]*/ "INR",
                "name": "PDF Printing System",
                "description": "Wallet Top-up",
                "order_id": /*[[${orderId}]]*/ "order_123",
                "handler": function (response){
                    // Create a form to submit the payment data
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/payment/callback';
                    
                    // Add payment response fields
                    var fields = {
                        'razorpay_payment_id': response.razorpay_payment_id,
                        'razorpay_order_id': response.razorpay_order_id,
                        'razorpay_signature': response.razorpay_signature,
                        'wallet_amount': /*[[${walletAmount}]]*/ 100,
                        'user_id': /*[[${userId}]]*/ 1
                    };
                    
                    for(var key in fields) {
                        var hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = key;
                        hiddenField.value = fields[key];
                        form.appendChild(hiddenField);
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                },
                "prefill": {
                    "name": /*[[${userName}]]*/ "John Doe",
                    "email": /*[[${userEmail}]]*/ "john@example.com",
                    "contact": /*[[${userPhone}]]*/ ""
                },
                "notes": {
                    "wallet_amount": /*[[${walletAmount}]]*/ 100,
                    "service_fee": /*[[${serviceFeeAmount}]]*/ 2.00
                },
                "theme": {
                    "color": "#0d6efd"
                },
                "modal": {
                    "ondismiss": function(){
                        window.location.href = '/student/wallet';
                    }
                }
            };
            
            var rzp = new Razorpay(options);
            
            document.getElementById('rzp-button').onclick = function(e){
                console.log('Opening Razorpay modal...');
                console.log('Options:', options);
                
                // Check if Razorpay is loaded
                if (typeof Razorpay === 'undefined') {
                    console.error('Razorpay script not loaded! Simulating payment for testing...');
                    alert('Razorpay script blocked by network/ad-blocker. Simulating payment...');
                    
                    // Simulate successful payment for testing
                    var mockResponse = {
                        razorpay_payment_id: 'pay_test_' + Date.now(),
                        razorpay_order_id: options.order_id,
                        razorpay_signature: 'test_signature_' + Date.now()
                    };
                    
                    options.handler(mockResponse);
                    return;
                }
                
                rzp.open();
                e.preventDefault();
            }
            
            rzp.on('payment.failed', function (response){
                console.error('Payment failed:', response);
                alert('Payment failed: ' + response.error.description);
                window.location.href = '/student/wallet';
            });
            
            // Add success logging
            rzp.on('payment.success', function (response){
                console.log('Payment success:', response);
            });
        </script>
    </div>
</body>
</html>